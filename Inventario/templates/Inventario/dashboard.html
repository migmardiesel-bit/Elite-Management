{% extends 'Inventario/base.html' %}

{% block page_title %}Executive Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-4 mb-3 border-bottom animate-fade-in">
        <div>
            <h2 class="h2 fw-bold" style="color: var(--elite-dark);">Overview</h2>
            <p class="text-muted mb-0">Welcome back, {{ request.user.username|default:"Admin" }}</p>
        </div>
        
        <div class="d-flex gap-3 align-items-center mt-3 mt-md-0">
            
            <div class="d-flex gap-2 bg-light p-1 rounded-3 border">
                <a href="https://calendar.google.com/calendar/u/0/r" target="_blank" 
                   class="btn btn-white bg-white border-0 shadow-sm d-flex align-items-center justify-content-center action-hover-btn" 
                   style="width: 40px; height: 40px;"
                   data-bs-toggle="tooltip"
                   title="Open Google Calendar">
                    <i class="fas fa-calendar-alt fs-5" style="color: #4285F4;"></i>
                </a>
                
                <a href="?export=dashboard_excel" 
                   class="btn btn-white bg-white border-0 shadow-sm d-flex align-items-center justify-content-center action-hover-btn" 
                   style="width: 40px; height: 40px;"
                   data-bs-toggle="tooltip"
                   title="Download General Report">
                    <i class="fas fa-file-download fs-5 text-success"></i>
                </a>
            </div>

            <div class="vr text-muted opacity-25 mx-1 d-none d-sm-block"></div>

            <div class="d-flex gap-2">
                <a href="{% url 'producto_create' %}" class="btn btn-light bg-white border shadow-sm fw-bold text-muted action-hover-btn d-flex align-items-center">
                    <i class="fas fa-box me-md-2 text-secondary"></i>
                    <span class="d-none d-md-inline">Product</span>
                </a>
                
                <a href="{% url 'movimiento_create' %}" class="btn btn-elite shadow px-4 fw-bold action-hover-btn d-flex align-items-center">
                    <i class="fas fa-plus me-md-2"></i>
                    <span class="d-none d-md-inline">New Movement</span>
                </a>
            </div>
        </div>
    </div>

    <div class="row mb-4 metrics-row g-3">
        <div class="col-md-3">
            <div class="card card-elite p-4 text-center h-100 metric-card animate-slide-up" data-delay="0">
                <div class="metric-icon mb-3">
                    <div class="icon-circle bg-light text-primary">
                        <i class="fas fa-boxes"></i>
                    </div>
                </div>
                <h6 class="text-muted text-uppercase small fw-bold">Total Products</h6>
                <h2 style="color: var(--elite-dark)" class="counter mb-0" data-target="{{ total_productos }}">0</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-elite p-4 text-center h-100 metric-card animate-slide-up" data-delay="100">
                <div class="metric-icon mb-3">
                    <div class="icon-circle bg-danger bg-opacity-10 text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <h6 class="text-muted text-uppercase small fw-bold">Stock Alerts</h6>
                <h2 class="text-danger counter mb-0" data-target="{{ alertas_bajo_stock }}">0</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-elite p-4 text-center h-100 metric-card animate-slide-up" data-delay="200">
                <div class="metric-icon mb-3">
                    <div class="icon-circle bg-success bg-opacity-10 text-success">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <h6 class="text-muted text-uppercase small fw-bold">Inventory Value</h6>
                <h3 style="color: var(--elite-primary)" class="counter mb-0" data-target="{{ valor_inventario|floatformat:0 }}">0</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-elite p-4 text-center h-100 metric-card animate-slide-up" data-delay="300">
                <div class="metric-icon mb-3">
                    <div class="icon-circle bg-info bg-opacity-10 text-info">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <h6 class="text-muted text-uppercase small fw-bold">Movements Today</h6>
                <h3 style="color: var(--elite-dark)" class="counter mb-0" data-target="{{ movimientos_hoy|default:0 }}">0</h3>
            </div>
        </div>
    </div>

    <div class="row mb-4 g-3">
        
        <div class="col-md-5">
            <div class="card shadow-sm border-0 h-100 animate-slide-left">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0 fw-bold text-secondary">Products by Category</h6>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-7">
            <div class="card shadow-sm border-0 h-100 animate-slide-right">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-secondary">Valuation by Site (Summary)</h6>
                    <span class="badge bg-success bg-opacity-10 text-success">Live Data</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Site / Warehouse</th>
                                    <th class="text-center">Items</th>
                                    <th class="text-end pe-4">Total Value</th>
                                    <th class="text-end pe-3">Share</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bodega in bodegas_summary %}
                                <tr>
                                    <td class="ps-4 fw-bold text-dark">
                                        <i class="fas fa-warehouse text-muted me-2"></i>{{ bodega.name }}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-light text-dark border">{{ bodega.total_items }}</span>
                                    </td>
                                    <td class="text-end pe-4 fw-bold text-success">
                                        ${{ bodega.value|floatformat:2 }}
                                    </td>
                                    <td class="text-end pe-3">
                                        <div class="progress" style="height: 6px; width: 60px; display: inline-flex;">
                                            <div class="progress-bar bg-elite" role="progressbar" 
                                                 style="width: {% widthratio bodega.value valor_inventario 100 %}%">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="4" class="text-center py-4 text-muted">No inventory in sites.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card shadow-sm table-card border-0 h-100 animate-slide-left">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-danger fw-bold"><i class="fas fa-exclamation-circle me-2 pulse-warning"></i>Critical Stock</h6>
                    <a href="{% url 'producto_list' %}?q=&categoria=&stock=low" class="small text-decoration-none">View All</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-3">Product</th>
                                <th class="text-center">Current</th>
                                <th class="text-center">Min</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prod in productos_bajo_stock %}
                            <tr class="animate-fade-in-row" style="animation-delay: {% widthratio forloop.counter 1 50 %}ms">
                                <td class="ps-3 fw-bold text-dark">{{ prod.nombre|truncatechars:25 }}</td>
                                <td class="text-center fw-bold text-danger fs-5">{{ prod.stock_actual }}</td>
                                <td class="text-center text-muted">{{ prod.stock_minimo }}</td>
                                <td><span class="badge bg-danger bg-opacity-10 text-danger">Restock</span></td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center py-4 text-muted">No critical stock alerts. <i class="fas fa-check-circle text-success ms-1"></i></td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm table-card border-0 h-100 animate-slide-right">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-primary">Recent Activity</h6>
                    <a href="{% url 'reporte_movimientos' %}" class="small text-decoration-none">History</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-3">Type</th>
                                <th>Product</th>
                                <th class="text-center">Qty</th>
                                <th class="text-end pe-3">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mov in ultimos_movimientos %}
                            <tr class="animate-fade-in-row" style="animation-delay: {% widthratio forloop.counter 1 50 %}ms">
                                <td class="ps-3">
                                    {% if mov.tipo == 'IN' %}
                                        <span class="badge bg-success bg-opacity-10 text-success border border-success px-2">IN</span>
                                    {% elif mov.tipo == 'OUT' %}
                                        <span class="badge bg-warning bg-opacity-10 text-dark border border-warning px-2">OUT</span>
                                    {% elif 'ADJ' in mov.tipo %}
                                        <span class="badge bg-info bg-opacity-10 text-info border border-info px-2">ADJ</span>
                                    {% else %}
                                        <span class="badge bg-secondary bg-opacity-10 text-dark border border-secondary px-2">TRF</span>
                                    {% endif %}
                                </td>
                                <td class="text-dark small fw-bold">{{ mov.producto.nombre|truncatechars:20 }}</td>
                                <td class="text-center fw-bold">
                                    {% if mov.tipo == 'IN' or 'POS' in mov.tipo %}+{% else %}-{% endif %}{{ mov.cantidad }}
                                </td>
                                <td class="text-end pe-3 text-muted small">{{ mov.fecha|date:"M d" }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center py-4 text-muted">No recent movements.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div style="position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
    <button id="btnOpenChat" class="btn btn-elite shadow-lg rounded-circle p-0 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; transition: transform 0.2s;">
        <i class="fas fa-robot fs-3"></i>
    </button>

    <div id="chatWindow" class="card shadow-lg border-0 d-none" style="width: 380px; position: absolute; bottom: 75px; right: 0; border-radius: 16px; overflow: hidden;">
        <div class="card-header bg-elite text-white d-flex justify-content-between align-items-center" style="background-color: var(--elite-primary); color: white;">
            <h6 class="mb-0"><i class="fas fa-brain me-2"></i>Elite AI Analyst</h6>
            <button id="btnCloseChat" class="btn btn-sm text-white"><i class="fas fa-times"></i></button>
        </div>
        <div class="card-body bg-light" style="height: 350px; overflow-y: auto;" id="chatBody">
            <div class="d-flex mb-3">
                <div class="bg-white p-3 rounded-3 shadow-sm text-muted small border" style="max-width: 85%;">
                    Hello! I am your <strong>Inventory & Financial Assistant</strong>. 
                    <br><br>
                    I can analyze costs, warehouse values, or generate Excel reports for you. Try asking:
                    <br><em>"Give me an Excel of expenses by unit"</em>
                </div>
            </div>
        </div>
        <div class="card-footer bg-white p-2">
            <div class="input-group">
                <input type="text" id="chatInput" class="form-control border-0 bg-light" placeholder="Ask me anything about your stock..." style="font-size: 0.9rem;">
                <button id="btnSend" class="btn btn-elite btn-sm"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos Personalizados */
    .icon-circle {
        width: 50px; height: 50px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        margin: 0 auto;
        font-size: 1.2rem;
    }
    .metric-card:hover .icon-circle {
        transform: scale(1.1);
        transition: transform 0.3s;
    }
    .action-hover-btn { transition: all 0.2s ease; }
    .action-hover-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1) !important;
        background-color: #f8f9fa !important;
    }
    .btn-elite.action-hover-btn:hover {
        background-color: var(--elite-dark) !important;
        color: white !important;
    }
    
    /* Animaciones */
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideLeft { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideRight { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulseWarning { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    
    .animate-slide-up { animation: slideUp 0.6s ease-out forwards; opacity: 0; }
    .animate-slide-left { animation: slideLeft 0.6s ease-out forwards; opacity: 0; }
    .animate-slide-right { animation: slideRight 0.6s ease-out forwards; opacity: 0; }
    .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
    .pulse-warning { animation: pulseWarning 2s infinite; }
</style>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // Registrar Plugin de Etiquetas
        Chart.register(ChartDataLabels);

        // --- 1. CHATBOT LOGIC ---
        const btnOpen = document.getElementById('btnOpenChat');
        const btnClose = document.getElementById('btnCloseChat');
        const chatWindow = document.getElementById('chatWindow');
        const btnSend = document.getElementById('btnSend');
        const chatInput = document.getElementById('chatInput');
        const chatBody = document.getElementById('chatBody');

        btnOpen.addEventListener('click', () => chatWindow.classList.remove('d-none'));
        btnClose.addEventListener('click', () => chatWindow.classList.add('d-none'));

        function parseMarkdown(text) {
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\[(.*?)\]\((.*?)\)/g, function(match, label, url) {
                return `<a href="${url}" class="btn btn-sm btn-success mt-2 mb-1 d-block text-center shadow-sm" target="_blank" style="text-decoration: none; color: white;">
                            <i class="fas fa-file-excel me-2"></i>${label}
                        </a>`;
            });
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            appendMessage(text, 'user');
            chatInput.value = '';
            const loadingId = appendLoading();
            scrollToBottom();

            try {
                const response = await fetch('/api/chat-ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pregunta: text })
                });
                const data = await response.json();
                removeMessage(loadingId);
                
                if (data.status === 'success') {
                    appendMessage(data.respuesta, 'ai-html');
                } else {
                    appendMessage("Error: " + data.message, 'ai');
                }
            } catch (error) {
                removeMessage(loadingId);
                appendMessage("Connection error with Elite Brain.", 'ai');
            }
            scrollToBottom();
        }

        btnSend.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function appendMessage(text, type) {
            const div = document.createElement('div');
            div.className = `d-flex mb-3 ${type === 'user' ? 'justify-content-end' : ''}`;
            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-3 shadow-sm small`;
            bubble.style.maxWidth = '85%';
            if (type === 'user') {
                bubble.className += ' bg-elite text-white';
                bubble.style.backgroundColor = 'var(--elite-primary)';
                bubble.innerText = text;
            } else if (type === 'ai-html') {
                bubble.className += ' bg-white text-dark border';
                bubble.innerHTML = parseMarkdown(text); 
            } else {
                bubble.className += ' bg-white text-dark border';
                bubble.innerText = text;
            }
            div.appendChild(bubble);
            chatBody.appendChild(div);
        }

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'd-flex mb-3';
            div.innerHTML = `<div class="bg-white p-2 rounded shadow-sm text-muted small border"><i class="fas fa-circle-notch fa-spin me-2 text-success"></i>Analyzing data...</div>`;
            chatBody.appendChild(div);
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // --- 2. DASHBOARD LOGIC ---
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        const counters = document.querySelectorAll('.counter');
        counters.forEach(counter => {
            const target = +counter.getAttribute('data-target');
            const duration = 1200; 
            const step = target / (duration / 16);
            let current = 0;
            const timer = setInterval(() => {
                current += step;
                if (current >= target) {
                    counter.textContent = target.toLocaleString();
                    clearInterval(timer);
                } else {
                    counter.textContent = Math.floor(current).toLocaleString();
                }
            }, 16);
        });

        document.querySelectorAll('.metric-card').forEach(card => {
            card.style.animationDelay = `${card.getAttribute('data-delay')}ms`;
        });
        
        // --- CHARTS CONFIGURATION ---
        const catLabels = JSON.parse('{{ chart_cat_labels|safe }}');
        const catData = JSON.parse('{{ chart_cat_data|safe }}');

        // Solo inicializamos el Doughnut (Categorías)
        // La gráfica de barras fue reemplazada por la tabla HTML en el código de arriba
        const ctxCat = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctxCat, {
            type: 'doughnut',
            data: {
                labels: catLabels,
                datasets: [{
                    data: catData,
                    backgroundColor: ['#435712', '#AAB646', '#2c3e10', '#6c757d', '#ffc107', '#17a2b8'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'right', labels: { boxWidth: 10 } },
                    // ETIQUETAS DE DATOS (NÚMEROS)
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold' },
                        formatter: (value) => value > 0 ? value : '',
                        textStrokeColor: 'rgba(0,0,0,0.5)',
                        textStrokeWidth: 2
                    }
                }
            }
        });
    });
</script>
{% endblock %}